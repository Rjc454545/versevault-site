<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerseVault - Faith-Based Cognitive Wellness</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üìñ</text></svg>">
    
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>emailjs.init("J6uqkUNXpWvW24wQj");</script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 18px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 5px solid #FF8C00;
            box-shadow: 0 0 0 5px #FFD700;
        }
        .header h1 { color: #000DFF; font-size: 48px; margin-bottom: 10px; }
        
        /* Cards */
        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 5px solid #FF8C00;
            box-shadow: 0 0 0 5px #FFD700;
        }
        
        /* Buttons */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: scale(1.05); opacity: 0.9; }
        
        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        /* Exercise Grid */
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .exercise-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            border: 3px solid #FF8C00;
            transition: all 0.3s;
            text-align: center;
        }
        .exercise-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .exercise-card.locked { opacity: 0.5; cursor: not-allowed; }
        .exercise-icon { font-size: 48px; margin-bottom: 10px; }
        .exercise-title { font-size: 18px; font-weight: bold; color: #764ba2; margin-bottom: 5px; }
        .exercise-count { font-size: 14px; color: #666; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Admin Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #667eea; color: white; }
        .code-available { background: #d4edda; }
        .code-used { background: #f8d7da; }
        
        @media (max-width: 768px) {
            body { padding: 10px; font-size: 16px; }
            .header h1 { font-size: 32px; }
            .exercise-grid { grid-template-columns: 1fr; }
            .btn { padding: 12px 20px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- WELCOME DISCLAIMER MODAL -->
        <div id="welcomeModal" class="modal" style="display: flex;">
            <div class="modal-content">
                <h1 style="color: #764ba2; text-align: center; margin-bottom: 20px;">üìñ Welcome to VerseVault</h1>
                <p style="text-align: center; margin: 20px 0; font-style: italic;">
                    "I have hidden your word in my heart that I might not sin against you."<br>
                    <strong>- Psalm 119:11</strong>
                </p>
                
                <!-- Audio Welcome Button -->
                <div style="text-align: center; margin: 20px 0;">
                    <button onclick="playWelcomeAudio()" class="btn btn-primary" id="welcomeAudioBtn">
                        üé§ Hear Welcome Message
                    </button>
                </div>
                
                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin-bottom: 10px;">‚ú® What You'll Get:</h3>
                    <ul style="line-height: 1.8; color: #333;">
                        <li>‚úÖ <strong>21 Scripture-based exercises</strong></li>
                        <li>‚úÖ <strong>945 cognitive activities</strong></li>
                        <li>‚úÖ Memory, attention, and focus training</li>
                        <li>‚úÖ Audio Scripture feature with voice narration</li>
                        <li>‚úÖ Progress tracking and daily streaks</li>
                        <li>‚úÖ Multi-language support (5 languages)</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Important Disclaimer:</h3>
                    <p style="line-height: 1.6; color: #856404;">
                        VerseVault is a <strong>faith-based wellness application</strong> for spiritual growth 
                        and cognitive engagement. It is <strong>NOT a medical device</strong> and is NOT a substitute 
                        for professional medical care, diagnosis, or treatment. Always consult qualified healthcare 
                        professionals for medical advice regarding Alzheimer's, dementia, or any health condition.
                    </p>
                </div>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #2196f3;">
                    <h3 style="color: #1565c0; margin-bottom: 10px;">üìã By Clicking "I Agree" You Acknowledge:</h3>
                    <ul style="line-height: 1.6; color: #1565c0; font-size: 14px;">
                        <li>You understand this is NOT medical treatment</li>
                        <li>You will seek professional medical advice when needed</li>
                        <li>You use this app entirely at your own risk</li>
                        <li>You release us from all liability</li>
                    </ul>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; font-size: 20px; padding: 20px;" onclick="acceptDisclaimer()">
                    ‚úÖ I AGREE - Continue to VerseVault
                </button>
                <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #999;">
                    By clicking "I Agree" you accept all terms and disclaimers
                </p>
            </div>
        </div>
        
        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="hidden">
            <div class="header">
                <h1>üìñ VerseVault</h1>
                <p style="color: #666; margin-top: 10px; font-size: 18px;">
                    Faith-Based Cognitive Wellness Application
                </p>
                <p style="color: #999; margin-top: 5px; font-size: 14px;">
                    Building On The Faith Ministry - Elder Robert Chalk Jr.
                </p>
            </div>
            
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 20px; color: #764ba2;">Welcome to VerseVault</h2>
                
                <!-- Audio Welcome Button on Login Screen -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button onclick="playWelcomeAudio()" class="btn btn-primary" style="font-size: 16px;">
                        üé§ Hear Welcome Message
                    </button>
                </div>
                
                <input type="text" id="username" placeholder="Enter Username">
                <input type="email" id="email" placeholder="Enter Email Address">
                <input type="password" id="password" placeholder="Password (optional for new accounts)">
                
                <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">
                    Sign In / Register
                </button>
                <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="showLifetimeModal()">
                    üíé Have a Lifetime Code?
                </button>
                
                <p style="text-align: center; margin-top: 20px; font-size: 12px; color: #999; cursor: pointer;" onclick="checkAdminAccess()">
                    ¬© 2024 Building On The Faith Ministry
                </p>
            </div>
        </div>
        
        <!-- DASHBOARD -->
        <div id="dashboardScreen" class="hidden">
            <div class="header">
                <h1>üìñ VerseVault</h1>
                <h2 id="welcomeMsg" style="color: #764ba2; margin-top: 10px;">Welcome!</h2>
                
                <!-- Audio Welcome Button on Dashboard -->
                <div style="margin-top: 15px;">
                    <button onclick="playWelcomeAudio()" class="btn btn-primary" style="font-size: 14px; padding: 10px 20px;">
                        üé§ Hear Welcome
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 20px; background: #f0f0f0; border-radius: 10px;">
                        <div style="font-size: 36px; color: #667eea; font-weight: bold;" id="statPoints">0</div>
                        <div style="color: #666; font-size: 14px;">Points</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f0f0f0; border-radius: 10px;">
                        <div style="font-size: 36px; color: #667eea; font-weight: bold;" id="statStreak">0</div>
                        <div style="color: #666; font-size: 14px;">Streak</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f0f0f0; border-radius: 10px;">
                        <div style="font-size: 36px; color: #667eea; font-weight: bold;" id="statCompleted">0</div>
                        <div style="color: #666; font-size: 14px;">Completed</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #764ba2;">Choose an Exercise:</h3>
                <div id="exerciseGrid" class="exercise-grid"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è Settings</button>
                    <button class="btn btn-primary" onclick="showSurveys()" style="margin-left: 10px;">üìä Surveys</button>
                    <button class="btn btn-warning" onclick="signOut()" style="margin-left: 10px;">üö™ Sign Out</button>
                </div>
            </div>
        </div>
        
        <!-- ACTIVITY SCREEN -->
        <div id="activityScreen" class="hidden">
            <div class="card">
                <button class="btn btn-secondary" onclick="exitActivity()">‚Üê Back to Dashboard</button>
                <div id="activityContent" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- LIFETIME CODE MODAL -->
        <div id="lifetimeModal" class="modal">
            <div class="modal-content">
                <h2 style="text-align: center; color: #764ba2; margin-bottom: 20px;">üíé Activate Lifetime Code</h2>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px solid #ff9800;">
                    <p style="color: #856404; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è DEVICE LIMIT POLICY:</p>
                    <p style="color: #856404; font-size: 14px;">‚Ä¢ Each code works on <strong>2 devices maximum</strong></p>
                    <p style="color: #856404; font-size: 14px;">‚Ä¢ A 3rd device will <strong>permanently deactivate</strong> the code</p>
                </div>
                
                <input type="text" id="lifetimeUsername" placeholder="Enter Username">
                <input type="email" id="lifetimeEmail" placeholder="Enter Email Address">
                <input type="text" id="lifetimeCode" placeholder="VV-LIFE-2024-XXXX" style="text-transform: uppercase;">
                
                <button class="btn btn-success" style="width: 100%;" onclick="activateLifetimeCode()">
                    ‚úÖ Activate Code
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="closeLifetimeModal()">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- SETTINGS MODAL -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <h2 style="text-align: center; color: #764ba2; margin-bottom: 20px;">‚öôÔ∏è Settings</h2>
                <div id="settingsContent"></div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="closeSettings()">
                    Close Settings
                </button>
            </div>
        </div>
        
        <!-- ADMIN MODAL -->
        <div id="adminModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #764ba2; margin: 0;">üîê Admin Panel</h2>
                    <button class="btn btn-danger" onclick="closeAdmin()">‚úï Close</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showAdminTab('codes')">Lifetime Codes</button>
                    <button class="btn btn-primary" onclick="showAdminTab('users')">Users</button>
                    <button class="btn btn-primary" onclick="showAdminTab('surveys')">Surveys</button>
                </div>
                
                <div id="adminContent" style="margin-top: 20px;"></div>
            </div>
        </div>
        
    </div>

    <script>
        // ===================================
        // GLOBAL STATE - WINDOW SCOPE
        // ===================================
        window.currentUser = null;
        window.currentExercise = null;
        window.currentActivityIndex = 0;
        window.adminClickCount = 0;
        window.MAX_DEVICES = 2;
        
        // ===================================
        // AUDIO WELCOME FUNCTION (FIXED)
        // ===================================
        window.playWelcomeAudio = function() {
            console.log('üé§ Playing welcome audio...');
            
            if (!('speechSynthesis' in window)) {
                alert('Sorry, your browser does not support text-to-speech. Please try Chrome, Safari, or Edge.');
                return;
            }
            
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            // Button feedback
            const btn = event?.target || document.getElementById('welcomeAudioBtn');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = 'üîä Playing...';
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 8000);
            }
            
            // Create utterance
            const utterance = new SpeechSynthesisUtterance();
            utterance.text = "Welcome to VerseVault. I have hidden your word in my heart, that I might not sin against you. Psalm 119 verse 11.";
            utterance.rate = 0.85;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            utterance.lang = 'en-US';
            
            // Try to get a female voice
            function setVoiceAndSpeak() {
                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(v => 
                    v.lang.includes('en') && 
                    (v.name.includes('Female') || v.name.includes('Samantha') || v.name.includes('Victoria'))
                ) || voices.find(v => v.lang.includes('en'));
                
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }
                
                window.speechSynthesis.speak(utterance);
                console.log('‚úÖ Welcome audio playing!');
            }
            
            // Wait for voices to load
            if (window.speechSynthesis.getVoices().length === 0) {
                window.speechSynthesis.onvoiceschanged = function() {
                    setVoiceAndSpeak();
                    window.speechSynthesis.onvoiceschanged = null;
                };
            } else {
                setVoiceAndSpeak();
            }
        };
        
        // ===================================
        // DATA INITIALIZATION
        // ===================================
        
        // Initialize 5000 lifetime codes
        function initLifetimeCodes() {
            let codes = JSON.parse(localStorage.getItem('vv_lifetime_codes') || '[]');
            if (codes.length !== 5000) {
                console.log('Initializing 5000 lifetime codes...');
                codes = [];
                for (let i = 1; i <= 5000; i++) {
                    codes.push({
                        code: `VV-LIFE-2024-${String(i).padStart(4, '0')}`,
                        used: false,
                        usedBy: null,
                        usedDate: null,
                        devices: [],
                        deactivated: false,
                        deactivatedReason: null
                    });
                }
                localStorage.setItem('vv_lifetime_codes', JSON.stringify(codes));
                console.log('‚úÖ 5000 lifetime codes initialized!');
            }
            return codes;
        }
        
        window.lifetimeCodes = initLifetimeCodes();
        window.users = JSON.parse(localStorage.getItem('vv_users') || '{}');
        
        // Save data function
        window.saveData = function() {
            localStorage.setItem('vv_lifetime_codes', JSON.stringify(window.lifetimeCodes));
            localStorage.setItem('vv_users', JSON.stringify(window.users));
            console.log('üíæ Data saved to localStorage');
        };
        
        // ===================================
        // EXERCISE DATA (21 exercises)
        // ===================================
        window.exercises = [
            {id: 'fillBlank', name: 'Fill in the Blank', icon: 'üìù', count: 45},
            {id: 'verseMatch', name: 'Verse Matching', icon: 'üîó', count: 45},
            {id: 'trueFalse', name: 'True or False', icon: '‚úì‚úó', count: 45},
            {id: 'multipleChoice', name: 'Multiple Choice', icon: 'üìä', count: 45},
            {id: 'characterQuiz', name: 'Character Quiz', icon: 'üë§', count: 45},
            {id: 'placesQuiz', name: 'Places Quiz', icon: 'üó∫Ô∏è', count: 45},
            {id: 'storySequence', name: 'Story Sequencing', icon: 'üìö', count: 45},
            {id: 'numberMemory', name: 'Number Memory', icon: 'üî¢', count: 45},
            {id: 'parables', name: 'Parables', icon: 'üå±', count: 45},
            {id: 'prophets', name: 'Prophet ID', icon: 'üë®‚Äçü¶≥', count: 45},
            {id: 'miracles', name: 'Miracles', icon: '‚ú®', count: 45},
            {id: 'timeline', name: 'Timeline', icon: '‚è∞', count: 45},
            {id: 'wordRecall', name: 'Word Recall', icon: 'üí≠', count: 45},
            {id: 'psalmMemory', name: 'Psalm Memory', icon: 'üéµ', count: 45},
            {id: 'prayer', name: 'Prayer', icon: 'üôè', count: 45},
            {id: 'fruitSpirit', name: 'Fruit of Spirit', icon: 'üçá', count: 45},
            {id: 'commandments', name: 'Commandments', icon: 'üìú', count: 45},
            {id: 'genealogy', name: 'Genealogy', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', count: 45},
            {id: 'beatitudes', name: 'Beatitudes', icon: 'üòá', count: 45},
            {id: 'disciples', name: 'Disciples', icon: 'üë•', count: 45},
            {id: 'audioActivity', name: 'Audio Scripture', icon: 'üé§', count: 45}
        ];
        
        // Sample activities (keep your full 945 activities from original file)
        window.activities = {
            fillBlank: [
                {q: "For God so loved the world, that he gave his only begotten ___", a: "Son", r: "John 3:16"},
                {q: "I can do all things through Christ which ___ me", a: "strengtheneth", r: "Philippians 4:13"},
                {q: "The Lord is my ___; I shall not want", a: "shepherd", r: "Psalm 23:1"},
                {q: "Trust in the Lord with all thine ___", a: "heart", r: "Proverbs 3:5"},
                {q: "Be still, and know that I am ___", a: "God", r: "Psalm 46:10"}
            ]
        };
        
        // ===================================
        // DEVICE FINGERPRINTING
        // ===================================
        window.getDeviceFingerprint = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('VerseVault', 2, 2);
            const canvasData = canvas.toDataURL();
            
            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvas: canvasData.substring(0, 50)
            };
            
            const str = JSON.stringify(fingerprint);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return `device_${Math.abs(hash).toString(36)}`;
        };
        
        // ===================================
        // DISCLAIMER ACCEPTANCE
        // ===================================
        window.acceptDisclaimer = function() {
            localStorage.setItem('vv_disclaimer_accepted', 'true');
            document.getElementById('welcomeModal').style.display = 'none';
            document.getElementById('loginScreen').classList.remove('hidden');
            console.log('‚úÖ Disclaimer accepted - showing login screen');
        };
        
        // Check on page load
        window.addEventListener('DOMContentLoaded', function() {
            const accepted = localStorage.getItem('vv_disclaimer_accepted');
            if (accepted === 'true') {
                document.getElementById('welcomeModal').style.display = 'none';
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });
        
        // ===================================
        // LOGIN/REGISTRATION
        // ===================================
        window.handleLogin = function() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username) {
                alert('‚ùå Please enter a username');
                return;
            }
            
            if (!email) {
                alert('‚ùå Please enter an email address');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('‚ùå Please enter a valid email address');
                return;
            }
            
            // Create or load user
            if (!window.users[username]) {
                window.users[username] = {
                    username: username,
                    email: email,
                    password: password,
                    accountType: 'trial',
                    createdDate: new Date().toISOString(),
                    trialStartDate: new Date().toISOString(),
                    points: 0,
                    streak: 0,
                    completed: 0,
                    progress: {}
                };
                window.saveData();
                console.log('‚úÖ New user created:', username);
            } else {
                console.log('‚úÖ Existing user loaded:', username);
            }
            
            window.currentUser = window.users[username];
            showDashboard();
        };
        
        // ===================================
        // DASHBOARD
        // ===================================
        window.showDashboard = function() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            
            document.getElementById('welcomeMsg').textContent = `Welcome, ${window.currentUser.username}!`;
            document.getElementById('statPoints').textContent = window.currentUser.points || 0;
            document.getElementById('statStreak').textContent = window.currentUser.streak || 0;
            document.getElementById('statCompleted').textContent = window.currentUser.completed || 0;
            
            renderExercises();
            console.log('‚úÖ Dashboard displayed');
        };
        
        window.renderExercises = function() {
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = '';
            
            window.exercises.forEach((ex, index) => {
                const isPremium = window.currentUser.accountType === 'premium' || 
                                 window.currentUser.accountType === 'lifetime' || 
                                 window.currentUser.accountType === 'family';
                const isTrial = window.currentUser.accountType === 'trial';
                const isUnlocked = isPremium || (isTrial && index < 3);
                
                const card = document.createElement('div');
                card.className = `exercise-card ${!isUnlocked ? 'locked' : ''}`;
                card.innerHTML = `
                    <div class="exercise-icon">${ex.icon}</div>
                    <div class="exercise-title">${ex.name}</div>
                    <div class="exercise-count">${ex.count} activities</div>
                    ${!isUnlocked ? '<div style="margin-top: 10px; font-
${!isUnlocked ? '<div style="margin-top: 10px; font-size: 24px;">üîí</div>' : ''}
                `;
                
                if (isUnlocked) {
                    card.onclick = () => startExercise(ex.id);
                } else {
                    card.onclick = () => alert('üîí This exercise is locked. Upgrade to Premium to unlock all 21 exercises!');
                }
                
                grid.appendChild(card);
            });
            
            console.log('‚úÖ Exercises rendered');
        };
        
        // ===================================
        // EXERCISE FUNCTIONALITY
        // ===================================
        window.startExercise = function(exerciseId) {
            window.currentExercise = exerciseId;
            window.currentActivityIndex = 0;
            
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('activityScreen').classList.remove('hidden');
            
            loadActivity();
            console.log('‚úÖ Started exercise:', exerciseId);
        };
        
        window.loadActivity = function() {
            const activities = window.activities[window.currentExercise];
            if (!activities || window.currentActivityIndex >= activities.length) {
                finishExercise();
                return;
            }
            
            const activity = activities[window.currentActivityIndex];
            const content = document.getElementById('activityContent');
            
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Activity ${window.currentActivityIndex + 1} of ${activities.length}</h3>
                    <div style="font-size: 20px; margin-bottom: 20px;">${activity.q}</div>
                    <input type="text" id="answerInput" placeholder="Type your answer..." style="font-size: 18px; padding: 15px;">
                    <button class="btn btn-primary" onclick="checkAnswer()" style="width: 100%; margin-top: 15px; font-size: 18px;">
                        ‚úÖ Submit Answer
                    </button>
                    <div id="feedback" style="margin-top: 20px;"></div>
                    ${activity.r ? `<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 14px;">üìñ ${activity.r}</div>` : ''}
                </div>
            `;
            
            document.getElementById('answerInput').focus();
        };
        
        window.checkAnswer = function() {
            const activities = window.activities[window.currentExercise];
            const activity = activities[window.currentActivityIndex];
            const userAnswer = document.getElementById('answerInput').value.trim().toLowerCase();
            const correctAnswer = activity.a.toLowerCase();
            
            const feedback = document.getElementById('feedback');
            
            if (userAnswer === correctAnswer) {
                feedback.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #28a745;">
                        <div style="font-size: 48px;">üéâ</div>
                        <div style="font-size: 24px; font-weight: bold; color: #155724;">Correct!</div>
                        <div style="color: #155724;">You earned 10 points!</div>
                    </div>
                `;
                
                window.currentUser.points += 10;
                window.currentUser.completed++;
                window.saveData();
                
                setTimeout(() => {
                    window.currentActivityIndex++;
                    loadActivity();
                }, 2000);
            } else {
                feedback.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
                        <div style="font-size: 48px;">üí°</div>
                        <div style="font-size: 20px; font-weight: bold; color: #856404;">Let's Learn Together!</div>
                        <div style="color: #856404; margin-top: 10px;">The correct answer is:</div>
                        <div style="font-size: 24px; font-weight: bold; color: #856404; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            ${activity.a}
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    window.currentActivityIndex++;
                    loadActivity();
                }, 3000);
            }
        };
        
        window.finishExercise = function() {
            const content = document.getElementById('activityContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #764ba2; margin-bottom: 20px;">Exercise Complete!</h2>
                    <div style="font-size: 48px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                        ${window.currentUser.points} Points
                    </div>
                    <button class="btn btn-primary" onclick="exitActivity()" style="margin-top: 30px; font-size: 18px; padding: 15px 40px;">
                        Back to Dashboard
                    </button>
                </div>
            `;
        };
        
        window.exitActivity = function() {
            document.getElementById('activityScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            showDashboard();
        };
        
        // ===================================
        // LIFETIME CODE MODAL
        // ===================================
        window.showLifetimeModal = function() {
            document.getElementById('lifetimeModal').style.display = 'flex';
            console.log('‚úÖ Lifetime modal opened');
        };
        
        window.closeLifetimeModal = function() {
            document.getElementById('lifetimeModal').style.display = 'none';
            document.getElementById('lifetimeUsername').value = '';
            document.getElementById('lifetimeEmail').value = '';
            document.getElementById('lifetimeCode').value = '';
        };
        
        window.activateLifetimeCode = function() {
            const username = document.getElementById('lifetimeUsername').value.trim();
            const email = document.getElementById('lifetimeEmail').value.trim();
            const code = document.getElementById('lifetimeCode').value.trim().toUpperCase();
            
            if (!username || !email || !code) {
                alert('‚ùå Please fill in all fields');
                return;
            }
            
            // Find the code
            const codeObj = window.lifetimeCodes.find(c => c.code === code);
            
            if (!codeObj) {
                alert('‚ùå Invalid code. Please check and try again.');
                return;
            }
            
            if (codeObj.deactivated) {
                alert(`üö® CODE DEACTIVATED\n\nThis code has been permanently deactivated.\n\nReason: ${codeObj.deactivatedReason}\n\nContact: buildingonthefaithmin@gmail.com`);
                return;
            }
            
            // Get device fingerprint
            const deviceId = window.getDeviceFingerprint();
            
            // Check if device already registered
            if (!codeObj.devices) codeObj.devices = [];
            const existingDevice = codeObj.devices.find(d => d.deviceId === deviceId);
            
            if (existingDevice) {
                // Device already registered - allow access
                console.log('‚úÖ Device already registered');
            } else {
                // New device - check limit
                if (codeObj.devices.length >= window.MAX_DEVICES) {
                    // DEACTIVATE CODE
                    codeObj.deactivated = true;
                    codeObj.deactivatedReason = `Device limit exceeded (3+ devices) - Deactivated ${new Date().toLocaleDateString()}`;
                    window.saveData();
                    
                    alert(`üö® CODE DEACTIVATED\n\nThis code was already activated on 2 devices.\n\nYou attempted to use it on a 3rd device, which violates our policy.\n\nThe code has been PERMANENTLY DEACTIVATED.\n\nContact support: buildingonthefaithmin@gmail.com`);
                    return;
                }
                
                // Add device
                codeObj.devices.push({
                    deviceId: deviceId,
                    username: username,
                    email: email,
                    registeredDate: new Date().toISOString()
                });
                
                if (codeObj.devices.length === 1) {
                    codeObj.used = true;
                    codeObj.usedBy = username;
                    codeObj.usedDate = new Date().toISOString();
                }
            }
            
            // Create/update user
            if (!window.users[username]) {
                window.users[username] = {
                    username: username,
                    email: email,
                    password: '',
                    accountType: 'lifetime',
                    lifetimeCode: code,
                    deviceId: deviceId,
                    createdDate: new Date().toISOString(),
                    points: 0,
                    streak: 0,
                    completed: 0,
                    progress: {}
                };
            } else {
                window.users[username].accountType = 'lifetime';
                window.users[username].lifetimeCode = code;
                window.users[username].deviceId = deviceId;
            }
            
            window.saveData();
            
            alert(`‚úÖ LIFETIME CODE ACTIVATED!\n\nWelcome, ${username}!\n\nYou now have full access to all 21 exercises and 945 activities.\n\nDevice ${codeObj.devices.length} of 2 registered.\n\nEnjoy VerseVault!`);
            
            closeLifetimeModal();
            
            window.currentUser = window.users[username];
            showDashboard();
        };
        
        // ===================================
        // SETTINGS
        // ===================================
        window.showSettings = function() {
            document.getElementById('settingsModal').style.display = 'flex';
            
            const content = document.getElementById('settingsContent');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">Account Information</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <p><strong>Username:</strong> ${window.currentUser.username}</p>
                        <p><strong>Email:</strong> ${window.currentUser.email}</p>
                        <p><strong>Account Type:</strong> ${window.currentUser.accountType}</p>
                        <p><strong>Points:</strong> ${window.currentUser.points}</p>
                        <p><strong>Streak:</strong> ${window.currentUser.streak} days</p>
                        <p><strong>Completed:</strong> ${window.currentUser.completed} activities</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">Reset Progress</h3>
                    <button class="btn btn-warning" onclick="resetProgress()" style="width: 100%;">
                        üîÑ Reset Points & Progress
                    </button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">Audio Welcome</h3>
                    <button class="btn btn-primary" onclick="playWelcomeAudio()" style="width: 100%;">
                        üé§ Play Welcome Message
                    </button>
                </div>
            `;
        };
        
        window.closeSettings = function() {
            document.getElementById('settingsModal').style.display = 'none';
        };
        
        window.resetProgress = function() {
            if (confirm('Are you sure you want to reset your progress?\n\nThis will set your points, streak, and completed activities to 0.\n\nYour account type and access will NOT be affected.')) {
                window.currentUser.points = 0;
                window.currentUser.streak = 0;
                window.currentUser.completed = 0;
                window.currentUser.progress = {};
                window.saveData();
                
                alert('‚úÖ Progress reset complete!');
                closeSettings();
                showDashboard();
            }
        };
        
        // ===================================
        // ADMIN PANEL
        // ===================================
        window.checkAdminAccess = function() {
            window.adminClickCount++;
            
            if (window.adminClickCount >= 5) {
                window.adminClickCount = 0;
                const password = prompt('üîê Enter Admin Password:');
                
                if (password === 'FaithApp$2024') {
                    document.getElementById('adminModal').style.display = 'flex';
                    showAdminTab('codes');
                    console.log('‚úÖ Admin access granted');
                } else {
                    alert('‚ùå Incorrect password');
                }
            }
            
            setTimeout(() => { window.adminClickCount = 0; }, 2000);
        };
        
        window.showAdminTab = function(tab) {
            const content = document.getElementById('adminContent');
            
            if (tab === 'codes') {
                const total = window.lifetimeCodes.length;
                const used = window.lifetimeCodes.filter(c => c.used).length;
                const deactivated = window.lifetimeCodes.filter(c => c.deactivated).length;
                const available = total - used - deactivated;
                
                content.innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">
                        Lifetime Codes (${total} total)
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #d4edda; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #28a745;">${available}</div>
                            <div style="color: #155724;">Available</div>
                        </div>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #dc3545;">${used}</div>
                            <div style="color: #721c24;">Used</div>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #856404;">${deactivated}</div>
                            <div style="color: #856404;">Deactivated</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="exportCodes()" style="margin-right: 10px;">
                            üì• Export to CSV
                        </button>
                        <button class="btn btn-warning" onclick="resetAllCodes()">
                            üîÑ Reset All Codes
                        </button>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Status</th>
                                    <th>Used By</th>
                                    <th>Devices</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${window.lifetimeCodes.slice(0, 50).map(c => `
                                    <tr class="${c.deactivated ? 'code-used' : c.used ? 'code-used' : 'code-available'}">
                                        <td>${c.code}</td>
                                        <td>${c.deactivated ? 'üö´ Deactivated' : c.used ? 'üî¥ Used' : 'üü¢ Available'}</td>
                                        <td>${c.usedBy || '-'}</td>
                                        <td>${c.devices ? c.devices.length : 0}/2</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p style="text-align: center; margin-top: 10px; color: #666;">
                            Showing first 50 codes. Export CSV for full list.
                        </p>
                    </div>
                `;
            } else if (tab === 'users') {
                const userList = Object.values(window.users);
                const trial = userList.filter(u => u.accountType === 'trial').length;
                const premium = userList.filter(u => u.accountType === 'premium').length;
                const lifetime = userList.filter(u => u.accountType === 'lifetime').length;
                
                content.innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">
                        Users (${userList.length} total)
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #856404;">${trial}</div>
                            <div style="color: #856404;">Trial</div>
                        </div>
                        <div style="background: #cfe2ff; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #084298;">${premium}</div>
                            <div style="color: #084298;">Premium</div>
                        </div>
                        <div style="background: #d4edda; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #28a745;">${lifetime}</div>
                            <div style="color: #155724;">Lifetime</div>
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Account Type</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userList.map(u => `
                                    <tr>
                                        <td>${u.username}</td>
                                        <td>${u.email || 'N/A'}</td>
                                        <td>${u.accountType}</td>
                                        <td>${u.points || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (tab === 'surveys') {
                const surveys = JSON.parse(localStorage.getItem('vv_surveys') || '[]');
                
                content.innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">
                        Survey Responses (${surveys.length} total)
                    </h3>
                    
                    ${surveys.length === 0 ? `
                        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                            <p style="color: #666;">No survey responses yet</p>
                        </div>
                    ` : `
                        <button class="btn btn-primary" onclick="exportSurveys()" style="margin-bottom: 20px;">
                            üì• Export Surveys
                        </button>
                        
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${surveys.map((s, i) => `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                    <h4 style="color: #667eea; margin-bottom: 10px;">Response #${i + 1}</h4>
                                    <p><strong>Email:</strong> ${s.email}</p>
                                    <p><strong>Date:</strong> ${s.date}</p>
                                    <p><strong>Feedback:</strong> ${s.feedback}</p>
                                </div>
                            `).join('')}
                        </div>
                    `}
                `;
            }
            
            console.log('‚úÖ Admin tab displayed:', tab);
        };
        
        window.exportCodes = function() {
            let csv = 'Code,Status,Used By,Date Used,Devices\n';
            window.lifetimeCodes.forEach(c => {
                csv += `${c.code},${c.deactivated ? 'Deactivated' : c.used ? 'Used' : 'Available'},${c.usedBy || ''},${c.usedDate || ''},${c.devices ? c.devices.length : 0}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `versevault-codes-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            alert('‚úÖ Codes exported to CSV!');
        };
        
        window.resetAllCodes = function() {
            if (confirm('‚ö†Ô∏è Are you sure you want to reset ALL codes to unused?\n\nThis will:\n‚Ä¢ Mark all 5000 codes as available\n‚Ä¢ Clear usage history\n‚Ä¢ Clear device tracking\n\nExisting users will keep their lifetime access.')) {
                window.lifetimeCodes.forEach(c => {
                    c.used = false;
                    c.usedBy = null;
                    c.usedDate = null;
                    c.devices = [];
                    c.deactivated = false;
                    c.deactivatedReason = null;
                });
                window.saveData();
                alert('‚úÖ All codes reset!');
                showAdminTab('codes');
            }
        };
        
        window.closeAdmin = function() {
            document.getElementById('adminModal').style.display = 'none';
            console.log('‚úÖ Admin panel closed');
        };
        
        // ===================================
        // SURVEYS
        // ===================================
        window.showSurveys = function() {
            alert('üìä Survey feature coming soon!\n\nWe\'ll ask for your feedback after you complete 225 activities.');
        };
        
        // ===================================
        // SIGN OUT
        // ===================================
        window.signOut = function() {
            window.currentUser = null;
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            console.log('‚úÖ User signed out');
        };
        
        // ===================================
        // INITIALIZATION
        // ===================================
        console.log('üöÄ VerseVault initialized');
        console.log('üìä Stats:', {
            totalCodes: window.lifetimeCodes.length,
            totalUsers: Object.keys(window.users).length,
            exercises: window.exercises.length
        });
        
    </script>

</body>
</html>